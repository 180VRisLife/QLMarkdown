.DEFAULT_GOAL := all

SPACE     := $(null) $(null)
CURRENT_DIR := $(subst $(SPACE),"\\ ",$(CURDIR))

ifeq ($(BUILT_PRODUCTS_DIR),)
	BUILD_DIR=${CURRENT_DIR}/build
else
	BUILD_DIR=${BUILT_PRODUCTS_DIR}
endif

ifeq ($(ONLY_ACTIVE_ARCH),)
	ONLY_ACTIVE_ARCH=NO
endif

CXX=clang++
CFLAGS=-I "${CURRENT_DIR}"

bold := $(shell tput bold 2> /dev/null)
normal := $(shell tput sgr0 2> /dev/null)

ifndef NATIVE_ARCH
	NATIVE_ARCH := $(shell uname -m)
	# $(error NATIVE_ARCH is not set)
endif

CFLAGS+= -I "${BUILD_DIR}/pcre2-${NATIVE_ARCH}"

jpcre_files =

ifeq ($(NATIVE_ARCH),x86_64)
	libpcre_files += ${BUILD_DIR}/pcre2-x86_64/lib/libpcre2-32.a
else
	libpcre_files += ${BUILD_DIR}/pcre2-arm64/lib/libpcre2-32.a
endif

ifeq ($(ONLY_ACTIVE_ARCH),NO)
ifeq ($(NATIVE_ARCH),x86_64)
		# build arm code
		libpcre_files += ${BUILD_DIR}/pcre2-arm64/lib/libpcre2-32.a
else
		# build intel code
		libpcre_files += ${BUILD_DIR}/pcre2-x86_64/lib/libpcre2-32.a
endif
endif

clean:
	@echo "${bold}Cleaning libpcre…${normal}"
	${MAKE} clean
		
	@rm -r "${BUILD_DIR}/jpcre2.hpp" 2> /dev/null
	@echo ""

libpcre2: ${BUILD_DIR}/libpcre2-32.a
configure: ${CURRENT_DIR}/configure

${CURRENT_DIR}/configure:
	@echo "${bold}Generating the configure tool…${normal}"
	./autogen.sh
	
	
${BUILD_DIR}/jpcre2/include/jpcre2.hpp: | configure
	@echo "${bold}Building jpcre2.hpp…${normal}"
	./configure CFLAGS="-I${BUILD_DIR}/pcre2-${NATIVE_ARCH}/include" CXXFLAGS="-I${BUILD_DIR}/pcre2-${NATIVE_ARCH}/include" --prefix="${BUILD_DIR}/jpcre2" --enable-cpp11
	${MAKE} clean
	${MAKE}
	${MAKE} install
	@echo ""

${BUILD_DIR}/jpcre2.hpp: ${BUILD_DIR}/jpcre2/include/jpcre2.hpp
	@echo "${bold}Creating jpcre2.hpp…${normal}"
	@rm -f "${BUILD_DIR}/jpcre2.hpp" > /dev/null
	ln "${BUILD_DIR}/jpcre2/include/jpcre2.hpp" "${BUILD_DIR}/jpcre2.hpp"
	@echo ""
	
jpcre2.hpp: ${BUILD_DIR}/jpcre2.hpp

all: jpcre2.hpp
install: jpcre2.hpp

